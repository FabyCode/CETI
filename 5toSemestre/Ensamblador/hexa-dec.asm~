RS EQU P3.0
E EQU P3.1
DBLCD EQU P1
FUNCSET EQU 00111000B
DISPON EQU 00001100B
DISCLR EQU 00000001B
EMSET EQU 00000110B
CARLIN2 EQU 11000000B
INCUR EQU 10000000B
NUM EQU 80H
BCDBUFF EQU 81H
INICIO: CLR RS
CLR E
LCALL RETARD15MS
TIMES 4
MOV DBLCD, #(FUNCSET)
LCALL RETARD1MS
ENDM
MOV DBLCD, #(DISPON)
LCALL RETARD1MS
MOV DBLCD, #(DISPCLR)
LCALL RETARD5MS
MOV DBLCD, #(EMSET)
LCALL RETARD1MS
MOV DPTR, #INTR
LCALL MUESTRAS
MOV R2, #1D
MOV R1, #0D
MOV R0, #(NUM)
LCALL MEMR0
LCALL LEERLSB
MOV R0, #(NUM)
MOV @R0, A
MOV A, #10D
LCALL SETCUR
MOV A, #4DH
LCALL MUESMSB
LCALL LEERMSB
MOV R0, #(NUM)
SWAP A
ORL A, @R0
MOV @R0, A
MOV R2, #3D
MOV R1, #0D
MOV R0, #(BCDBUFF)
LCALL MEMSETBUFF
MOV R1, #(NUM)
MOV A, @R1
MOV R1, A
MOV R0, #(BCDBUFF)
LCALL BIN2BCD
CLR RS
MOV DBLCD, #(DISPCLR)
SETB E
LCALL RETARD15MS
CLR E
MOV A, #1D
LCALL SETCUR
MOV R0, #(NUM)
LCALL MUESHEX
MOV DPTR, #IGUAL
LCALL MUESTRAS
MOV R0, #(BCDBUFF)
LCALL MUESBCD
HALT: AJMP HALT
RETARD15MS: MOV R1, #30D
L3: MOV R0, #250D
L2: DJNZ R0, L2
DJNZ R1, L3
RET
RETARD5MS: SETB E
MOV R1, #10D
L5: MOV R0, #250D
L4: DJNZ R0, L4
DJNZ R1, L5
CLR E
RET
RET1MS: SETB E
MOV R1, #2D
L7: MOV R0, #250D
L6: DJNZ R0, L6
DJNZ R1, L7
CLR E
RET
RETARD1S: MOV R2, #8D
L10: MOV R1, #250D
L9: MOV R0, #250D
L8: DJNZ R0, L8
DJNZ R1, L9
DJNZ R2, L10
RET
MUESMSB: SETB RS
MOV DBLCD, A
ACALL RET1MS
RET
MUESTRAS: SETB RS
CLEARA: MOV A, 0 ; CLEAR A
MOVC A, @A+dptr
JZ PUTSFIN
INC DPTR
MOV DBLCD, A
ACALL RET1MS
AJMP CLEARA
PUTSFIN: RET
MUESBCD: MOV A, @R0
JZ DECENAS
ADD A, #30H
MOV B, R0
LCALL PUTC
MOV R0, B
DECENAS: INC R0
MOV A, @R0
JZ UNIDADES
ADD A, #30H
MOV B, R0
LCALL PUTC
MOV R0, B
UNIDADES: INC R0
MOV A, @R0
ADD A, #30H
MOV B, R0
LCALL MUESMSB
MOV R0, B
RET
MUESHEX:
MOV A, R0
MOV R7, A
MOV A, @R0
ANL A, #0F0H
SWAP A
ACALL PUT4BHEX
MOV A, R7
MOV R0, A
MOV A, @R0
ANL A, #0FH
ACALL PUT4BHEX
RET
PUT4BHEX: MOV B, A
CLR C
SUBB A, #10D
JC HEXNUM
HEXLET: ADD A, #41H
LCALL PUTC
AJMP P4BHFIN
HEXNUM: MOV A, B
ADD A, #30H
LCALL MUESMSB
P4BHFIN: RET
LINEA2: CLR RS
MOV DBLCD, #(DIRLINEA2)
LCALL RET1MS
RET
MEMSET: MOV A, R2
JZ FINMEMSET
DEC A
MOV R2, A
MOV A, R1
MOV @R0, A
INC R0
AJMP MEMSET
FINMEMSET: RET
BIN2BCD:
INC R0
INC R0
BIN2BCDLOOP: MOV A, R1
JZ FINBIN2BCD
MOV B, #10D
DIV AB ; B = A (MOD 10)
MOV R2, A
MOV A, B
MOV @R0, A
MOV A, R2
MOV R1, A
DEC R0
AJMP BIN2BCDLOOP
FINBIN2BCD: RET
SETCUR: CLR RS
ORL A, #(INSTRCUR)
MOV DBLCD, A
LCALL RET1MS
RET
LEERNUM: LCALL LINEA2
MOV DPTR, #CADENA_TIEMPO
LCALL PUTS
MOV R3, #8D
LOOPLEERN: MOV A, #7D
ADD A, #40H; (LINEA2)
ACALL SETCUR
MOV A, R3
ADD A, #30H;'0'
LCALL MUESMSB
LCALL RETARD1S
DJNZ R3, LOOPLEERN
MOV A, P3
ANL A, #0F0H
SWAP A
RET
INTR: DB 'Introduce LSB:\0'
CADENA_TIEMPO: DB 'Tienes 9 seg\0'
IGUAL: DB ' = \0'
END